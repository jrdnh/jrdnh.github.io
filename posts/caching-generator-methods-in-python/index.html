<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><title>Caching Generator Methods in Python &#183; jrdnh</title>
<meta name=title content="Caching Generator Methods in Python &#183; jrdnh"><script type=text/javascript src=/js/appearance.min.022d0ebc3b46a335eb1c7ef79b7f2de143d7cd5156d433638592ef1ce5f8554e.js integrity="sha256-Ai0OvDtGozXrHH73m38t4UPXzVFW1DNjhZLvHOX4VU4="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.846491e439ce18551a5c80d168997b32ad65350132e38fc9420189984a3e1a31.css integrity="sha256-hGSR5DnOGFUaXIDRaJl7Mq1lNQEy44/JQgGJmEo+GjE="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.5b9218820e6c6b9f04b4c5a03dffd0d57bc9189f511ee80ea74222de3a608e2f.js integrity="sha256-W5IYgg5sa58EtMWgPf/Q1XvJGJ9RHugOp0Ii3jpgji8=" data-copy=Copy data-copied=Copied></script><meta name=description content="
      
        Each code snippet should run as a standalone example (based on Python 3.
      
    "><link rel=canonical href=https://jrdnh.github.io/posts/caching-generator-methods-in-python/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Caching Generator Methods in Python"><meta property="og:description" content="Each code snippet should run as a standalone example (based on Python 3."><meta property="og:type" content="article"><meta property="og:url" content="https://jrdnh.github.io/posts/caching-generator-methods-in-python/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-30T13:25:41-05:00"><meta property="article:modified_time" content="2023-12-30T13:25:41-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Caching Generator Methods in Python"><meta name=twitter:description content="Each code snippet should run as a standalone example (based on Python 3."><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Caching Generator Methods in Python","headline":"Caching Generator Methods in Python","abstract":"Each code snippet should run as a standalone example (based on Python 3.","inLanguage":"en","url":"https:\/\/jrdnh.github.io\/posts\/caching-generator-methods-in-python\/","author":{"@type":"Person","name":""},"copyrightYear":"2023","dateCreated":"2023-12-30T13:25:41-05:00","datePublished":"2023-12-30T13:25:41-05:00","dateModified":"2023-12-30T13:25:41-05:00","mainEntityOfPage":"true","wordCount":"2322"}</script><script defer data-domain=jrdnh.github.io data-api=https://plausible.io/api/event src=https://plausible.io/js/script.js></script></head><body class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral"><div id=the-top class="absolute flex self-center"><a class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 print:hidden sm:py-10 dark:text-neutral"><nav class="flex items-start justify-between sm:items-center"><div class="z-40 flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>jrdnh</a></div><label id=menu-button for=menu-controller class="block sm:hidden"><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="invisible fixed inset-0 z-30 m-auto h-full w-full cursor-default overflow-auto bg-neutral-100/50 opacity-0 backdrop-blur-sm transition-opacity dark:bg-neutral-900/50"><ul class="mx-auto flex w-full max-w-7xl list-none flex-col overflow-visible px-6 py-6 text-end sm:px-14 sm:py-10 sm:pt-10 md:px-24 lg:px-32"><li class=mb-1><span class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class="group mb-1"><a href=/posts/ title onclick=close_menu()><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Posts</span></a></li><li class="group mb-1"><a href=https://github.com/jrdnh title onclick=close_menu() target=_blank><span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></li><li class="group mb-1"><button id=search-button-1 title="Search (/)">
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li><li class="group mb-1"><button id=appearance-switcher-1 type=button aria-label="appearance switcher">
<span class="group-dark:hover:text-primary-400 inline transition-colors group-hover:text-primary-600 dark:hidden" title="Switch to dark appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span>
</span><span class="group-dark:hover:text-primary-400 hidden transition-colors group-hover:text-primary-600 dark:inline" title="Switch to light appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></span></button></li></ul></div></label><ul class="hidden list-none flex-row text-end sm:flex"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=/posts/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Posts</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=https://github.com/jrdnh title target=_blank><span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><button id=search-button-2 title="Search (/)">
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><button id=appearance-switcher-2 type=button aria-label="appearance switcher">
<span class="group-dark:hover:text-primary-400 inline transition-colors group-hover:text-primary-600 dark:hidden" title="Switch to dark appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span>
</span><span class="group-dark:hover:text-primary-400 hidden transition-colors group-hover:text-primary-600 dark:inline" title="Switch to light appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></span></button></li></ul></nav></header><div class="relative flex grow flex-col"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Caching Generator Methods in Python</h1><div class="mb-12 mt-8 text-base text-neutral-500 print:hidden dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime="2023-12-30 13:25:41 -0500 -0500">30 December 2023</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">11 mins</span></div></div></header><section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8"><div class="toc pe-5 print:hidden lg:sticky lg:top-10"><details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5"><summary class="-ms-5 block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 lg:hidden dark:bg-neutral-700 dark:text-neutral-100">Table of Contents</summary><div class="-ms-5 border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><ul><li><a href=#use-weakref-to-store-a-reference-to-the-instance>Use <code>weakref</code> to store a reference to the instance</a></li><li><a href=#make-lru_cache-an-instance-attribute>Make <code>lru_cache</code> an instance attribute</a></li><li><a href=#make-the-cache-and-instance-attribute>Make the <em>cache</em> and instance attribute</a></li><li><a href=#dealing-with-mutability>Dealing with mutability</a></li></ul></li><li><a href=#using-tee-to-cache-generator-results>Using <code>Tee</code> to cache generator results</a></li><li><a href=#putting-it-all-together>Putting it all together</a></li><li><a href=#final-thoughts>Final thoughts</a></li></ul></nav></div></details></div></div><div class="min-h-0 min-w-0 max-w-prose grow"><p><em>Each code snippet should run as a standalone example (based on Python 3.12).</em></p><p>The standard library caching decorator <code>functools.lru_cache</code> has
<a href=https://docs.python.org/3/faq/programming.html#how-do-i-cache-method-calls target=_blank rel=noreferrer>known</a>
<a href=https://rednafi.com/python/lru_cache_on_methods/ target=_blank rel=noreferrer>limitations</a> when used with instance methods. In particular, the cache is a property of the class and holds references to each function argument. Since instances themselves are the first argument to instance methods (<code>self</code>), the class will end up storing a reference to each instance. This can lead to memory leaks where the instance&rsquo;s reference count never reaches zero, so it&rsquo;s never removed by the garbage collector.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>lru_cache</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>gc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Foo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nd>@lru_cache</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>bar</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;bar called&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;bar&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__del__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;deleting Foo instance </span><span class=si>{</span><span class=bp>self</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>foo</span> <span class=o>=</span> <span class=n>Foo</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>foo</span><span class=o>.</span><span class=n>bar</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># bar called</span>
</span></span><span class=line><span class=cl><span class=c1># &#39;bar&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># delete foo</span>
</span></span><span class=line><span class=cl><span class=k>del</span> <span class=n>foo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gc</span><span class=o>.</span><span class=n>collect</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># 0, nothing collected</span>
</span></span></code></pre></div><p>The simplest solution is use <code>@staticmethod</code>s. The instance object is not passed as the first argument to static methods, so the cache will not hold a reference to the instance. However, this is not always possible.</p><p>There has been some
<a href=https://github.com/python/cpython/issues/102618#issuecomment-1470778903 target=_blank rel=noreferrer>discussion</a> among core developers about addressing this issue in the standard library. In the meantime, there are a few workarounds.</p><ol><li><a href=###Use-weakref-to-store-a-reference-to-the-instance>Use <code>weakref</code> to store a reference to the instance</a></li><li><a href=###Making-the-cached-function-a-property-of-the-instance>Make <code>lru_cache</code> an instance attribute</a></li><li><a href=###Store-just-the-cache-as-a-property-of-the-instance>Make the <em>cache</em> an instance attribute</a></li></ol><h3 id=use-weakref-to-store-a-reference-to-the-instance class="relative group">Use <code>weakref</code> to store a reference to the instance <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#use-weakref-to-store-a-reference-to-the-instance aria-label=Anchor>#</a></span></h3><p>The first workaround is to use <code>weakref</code> to store a reference to the instance (i.e. the <code>self</code> argument). In fact, caching is a use case explicitly cited by the <code>weakref</code>
<a href=https://docs.python.org/3/library/weakref.html target=_blank rel=noreferrer>module</a> documentation. A solution using <code>weakref</code> might look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>functools</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>weakref</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>weak_cache</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cache</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@functools.wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># wrap `self` with weakref to avoid memory leaks</span>
</span></span><span class=line><span class=cl>        <span class=n>weak_self</span> <span class=o>=</span> <span class=n>weakref</span><span class=o>.</span><span class=n>ref</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=p>(</span><span class=n>weak_self</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=nb>tuple</span><span class=p>(</span><span class=nb>sorted</span><span class=p>(</span><span class=n>kwargs</span><span class=o>.</span><span class=n>items</span><span class=p>())))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>cache</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cache</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>wrapper</span>
</span></span></code></pre></div><p>Confirm that it works:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Foo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nd>@weak_cache</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>bar</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;bar called&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;bar&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__del__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;deleting Foo instance </span><span class=si>{</span><span class=bp>self</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>foo</span> <span class=o>=</span> <span class=n>Foo</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>foo</span><span class=o>.</span><span class=n>bar</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># bar called</span>
</span></span><span class=line><span class=cl><span class=c1># &#39;bar&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>del</span> <span class=n>foo</span>
</span></span><span class=line><span class=cl><span class=c1># deleting Foo instance &lt;__main__.Foo object at 0x10d2e1a30&gt;</span>
</span></span></code></pre></div><p>This approach works fine in many cases. However, not all objects can be weakly referenced. For example, in CPython built-ins such as <code>tuple</code> and <code>int</code> do not support weak references even when subclassed. Additionally, types with <code>__slots__</code> cannot by weakly referenced unless they have a <code>__weakref__</code> slot.</p><h3 id=make-lru_cache-an-instance-attribute class="relative group">Make <code>lru_cache</code> an instance attribute <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#make-lru_cache-an-instance-attribute aria-label=Anchor>#</a></span></h3><p>Another solution is to make the cached function a property of the instance. Since the <em>class</em> no longer holds a reference to the instance through the cache, it does not keep the instance alive.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Foo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>bar</span> <span class=o>=</span> <span class=n>lru_cache</span><span class=p>()(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bar</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_bar</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;bar&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__del__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;deleting Foo instance </span><span class=si>{</span><span class=bp>self</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>foo</span> <span class=o>=</span> <span class=n>Foo</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>foo</span><span class=o>.</span><span class=vm>__dict__</span>  <span class=c1># show that the `lru_cache` warpper is an instance attribute</span>
</span></span><span class=line><span class=cl><span class=c1># {&#39;bar&#39;: &lt;functools._lru_cache_wrapper object at 0x10a614bf0&gt;}</span>
</span></span><span class=line><span class=cl><span class=n>foo</span><span class=o>.</span><span class=n>bar</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># &#39;bar&#39;</span>
</span></span><span class=line><span class=cl><span class=n>foo</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=n>gc</span><span class=o>.</span><span class=n>collect</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># deleting Foo instance &lt;__main__.Foo object at 0x103298b30&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># 9</span>
</span></span></code></pre></div><p>The primary drawback with this approach is that it requires additional work to set the cached function as an attribute in the <code>__init__</code> method.</p><h3 id=make-the-cache-and-instance-attribute class="relative group">Make the <em>cache</em> and instance attribute <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#make-the-cache-and-instance-attribute aria-label=Anchor>#</a></span></h3><p>A third solution is to store just the <em>cache</em> as a property of the instance. This is similar to the previous solution, but just the cache is set as the instance attribute. The function wrapper—which we will have to implement—remains an attribute of the class. This avoids the need to set the cached function as an attribute in <code>__init__</code>. It can be used simply as a decorator on instance methods.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>wraps</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>caching_decorator</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cachename</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;_cached_</span><span class=si>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__qualname__</span><span class=si>}</span><span class=s2>_&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># try to get the cache from the object</span>
</span></span><span class=line><span class=cl>        <span class=n>cachedict</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>cachename</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># if the object doen&#39;t have a cache, try to create and add one</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cachedict</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cachedict</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=nb>setattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>cachename</span><span class=p>,</span> <span class=n>cachedict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># try to return a cached value,</span>
</span></span><span class=line><span class=cl>        <span class=c1># or if it doesn&#39;t exist, create it, cache it, and return it</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>cachedict</span><span class=p>[</span><span class=n>args</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cachedict</span><span class=p>[</span><span class=n>args</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>wrapper</span>
</span></span></code></pre></div><p>The decorator wraps instance methods with a function that checks the instance object for a matching cache attribute name. If the cache attribute exists, it is assumed to be a dictionary mapping function arguments to results. If the attribute does not exist, it is created. The function is then called and the result is stored in the dictionary before it is returned.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Foo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nd>@caching_decorator</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>bar</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>num</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;bar called with </span><span class=si>{</span><span class=n>num</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;bar&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__del__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;deleting Foo instance </span><span class=si>{</span><span class=bp>self</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>foo</span> <span class=o>=</span> <span class=n>Foo</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>foo</span><span class=o>.</span><span class=n>bar</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># bar called with 1</span>
</span></span><span class=line><span class=cl><span class=c1># &#39;bar&#39;</span>
</span></span><span class=line><span class=cl><span class=n>foo</span><span class=o>.</span><span class=n>bar</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># cached result is returned</span>
</span></span><span class=line><span class=cl><span class=c1># &#39;bar&#39;</span>
</span></span><span class=line><span class=cl><span class=n>foo</span><span class=o>.</span><span class=vm>__dict__</span>  <span class=c1># the cache is stored as an instance attribute</span>
</span></span><span class=line><span class=cl><span class=c1># {&#39;_cached_Foo.bar_&#39;: {(1,): &#39;bar&#39;}}</span>
</span></span><span class=line><span class=cl><span class=n>foo</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=c1># deleting Foo instance &lt;__main__.Foo object at 0x108dc6b70&gt;</span>
</span></span></code></pre></div><p>This approach requires work to implement. For instance, this version only works with positional arguments. There is also a risk of name collisions and name pollution. It is flexible and exposes the cache to the user which is helpful for building the generator cache in the next section.</p><h3 id=dealing-with-mutability class="relative group">Dealing with mutability <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#dealing-with-mutability aria-label=Anchor>#</a></span></h3><p>Mutability and hash-ability are a pervasive issues with caching in Python. The <code>functools.lru_cache</code> decorator, as well as all the other approaches discussed here, store results in a dictionary. Dictionary keys must be hashable. The function arguments are used as keys, which means they must be hashable as well. This is not a problem for most built-in, non-collection types, but it can be an issue for custom classes. Since the first argument to instance methods is the instance itself, the instance must be hashable. This
<a href="https://eng.lyft.com/hashing-and-equality-in-python-2ea8c738fb9d#:~:text=Retrieving%20an%20object%20by%20key&amp;text=To%20have%20functionally%20correct%20dictionaries,computed%20once%20it%20is%20inserted." target=_blank rel=noreferrer>Lyft Engineering blog post</a> has a good discussion of the issue.</p><p>The default behavior of <code>hash(self)</code> for custom classes is based on the object&rsquo;s ID. Object ID&rsquo;s are guaranteed to remain the same over the life of the object. As long as objects are immutable, this is fine. However, mutable objects with methods that access object properties can lead to unexpected behavior. Specifically, if a property that the method relies on is changed, the incorrect cached value will continue to be used because the default <code>hash</code> value will not change.</p><p>If you can&rsquo;t make objects (faux) immutable, there really isn&rsquo;t a great solution. One option is to use a custom <code>__hash__</code> method that returns a hash based on the object&rsquo;s properties. This approach has the desirable effect of invalidating the cache whenever a property is changed. However, is approach is generally not a good idea because it can lead to unexpected behavior in other places the object is used in a <code>dict</code> or <code>set</code>. These issues tend to be hard to debug. For example, if the object is used as a dictionary key elsewhere then changing the object&rsquo;s properties will change the hash value and the item will no longer be retrievable from the dictionary. Additionally, the cache will be invalidated if <em>any</em> property is changed, even if the method does not rely on that property.</p><p>A similar option would be to create the cache&rsquo;s key value inside the wrapper based on the object&rsquo;s <code>self.__dict__</code> key-value pairs (e.g. <code>hash(k, v for k, v in self.__dict__.items())</code>). This would avoid causing issues in other placess that <code>__hash__</code> is used. However, if the method relies on mutable properties, the cache could still return the incorrect value. It also continues to invalidate the cache whenever any property is changed, even if such property isn&rsquo;t used by the method.</p><blockquote><p><strong>Conclusion:</strong> Mutability is an issue with caching in Python. If you can&rsquo;t protect against properties that the method relies on from changing, consider using a different approach.</p></blockquote><h2 id=using-tee-to-cache-generator-results class="relative group">Using <code>Tee</code> to cache generator results <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#using-tee-to-cache-generator-results aria-label=Anchor>#</a></span></h2><p>The goal is to return a generator method that caches its results as <code>next</code> is called. So, if two generators are created from the method, they will share the same cache. The generator will only run once for each element of the series. This is useful for generators that are expensive to compute and are used multiple times.</p><p>This approach is inspired by
<a href=https://stackoverflow.com/a/10726355/18582661 target=_blank rel=noreferrer>this</a> Stack Overflow answer. It uses <code>itertools.tee</code> to create two copies of the generator. <code>tee</code> takes an iterable and returns multiple independent iterators that pull from the same source. The documentation has a
<a href=https://docs.python.org/3/library/itertools.html#itertools.tee target=_blank rel=noreferrer>full explanation</a> with example implementation.</p><p>Here, <code>tee</code> is used to create two iterators with the same source generator. One iterator is returned to the user, and the other copy is stored in the cache. The next time the generator is called, the cached copy is used to create two new copies and the process repeats.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>itertools</span> <span class=kn>import</span> <span class=n>tee</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>types</span> <span class=kn>import</span> <span class=n>GeneratorType</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Get the class returned by `itertools.tee` so we can check against it later</span>
</span></span><span class=line><span class=cl><span class=n>Tee</span> <span class=o>=</span> <span class=n>tee</span><span class=p>([],</span> <span class=mi>1</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=vm>__class__</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>memoized</span><span class=p>(</span><span class=n>f</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cache</span><span class=o>=</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>ret</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># check whether the generator has been called before with same arguments</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>args</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># if not, call the generator function</span>
</span></span><span class=line><span class=cl>            <span class=n>cache</span><span class=p>[</span><span class=n>args</span><span class=p>]</span><span class=o>=</span><span class=n>f</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># check whether the result is a generator (generator method has not been called before)</span>
</span></span><span class=line><span class=cl>        <span class=c1># or a Tee (generator method has been called before).</span>
</span></span><span class=line><span class=cl>        <span class=c1># this should be `True` unless the decorated method doesn&#39;t return a generator (e.g. regular function)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>cache</span><span class=p>[</span><span class=n>args</span><span class=p>],</span> <span class=p>(</span><span class=n>GeneratorType</span><span class=p>,</span> <span class=n>Tee</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=c1># create two new iterator copies, store one and return one</span>
</span></span><span class=line><span class=cl>            <span class=n>cache</span><span class=p>[</span><span class=n>args</span><span class=p>],</span> <span class=n>r</span> <span class=o>=</span> <span class=n>tee</span><span class=p>(</span><span class=n>cache</span><span class=p>[</span><span class=n>args</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>cache</span><span class=p>[</span><span class=n>args</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span>
</span></span></code></pre></div><p>Using it with the fibonacci sequence shows that the print function is only called once for each element in the sequence.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@memoized</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fibonator</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;yielding </span><span class=si>{</span><span class=n>a</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>a</span>
</span></span><span class=line><span class=cl>        <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=n>b</span><span class=p>,</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fib1</span> <span class=o>=</span> <span class=n>fibonator</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>next</span><span class=p>(</span><span class=n>fib1</span><span class=p>)</span>  <span class=c1># will print &#34;yielding&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># yielding 0</span>
</span></span><span class=line><span class=cl><span class=c1># 0</span>
</span></span><span class=line><span class=cl><span class=n>fib2</span> <span class=o>=</span> <span class=n>fibonator</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>next</span><span class=p>(</span><span class=n>fib2</span><span class=p>)</span>  <span class=c1># will not print &#34;yielding&#34;, uses cached value</span>
</span></span><span class=line><span class=cl><span class=c1># 0</span>
</span></span></code></pre></div><p>Copying iterables with <code>tee</code> trades memory for speed. Generators are often used precisely because they don&rsquo;t require storing the entire series in memory. This approach conflicts with that. There are other scenarios where generators are useful, for example where the series has an indefinite length or can&rsquo;t be computed ahead of time, that the tradeoff makes sense.</p><h2 id=putting-it-all-together class="relative group">Putting it all together <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#putting-it-all-together aria-label=Anchor>#</a></span></h2><p>The following class calculates periodic revenue growing at a constant annual rate. The class has two methods: <code>periods</code> which returns a generator of <code>(start, end)</code> tuples, and <code>amount</code> which calculates revenue iteratively for the given period. Growth compounds each period based on the actual number of days and a 360 day year. This type of formula is common in financial modeling.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>date</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dateutil.relativedelta</span> <span class=kn>import</span> <span class=n>relativedelta</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Operations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>start_date</span><span class=p>:</span> <span class=n>date</span>
</span></span><span class=line><span class=cl>    <span class=n>freq</span><span class=p>:</span> <span class=n>relativedelta</span>
</span></span><span class=line><span class=cl>    <span class=n>initial_rev</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>growth_rate</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>periods</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Revenue growth periods&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>curr</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>start_date</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>start_date</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>freq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>curr</span>
</span></span><span class=line><span class=cl>            <span class=n>curr</span> <span class=o>=</span> <span class=p>(</span><span class=n>curr</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>curr</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>freq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>amount</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>period_end</span><span class=p>:</span> <span class=n>date</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Revenue for period&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>revenue</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>initial_rev</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>start</span><span class=p>,</span> <span class=n>end</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>periods</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>period_end</span> <span class=o>&lt;=</span> <span class=n>start</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>revenue</span>
</span></span><span class=line><span class=cl>            <span class=n>revenue</span> <span class=o>*=</span> <span class=mi>1</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>growth_rate</span> <span class=o>*</span> <span class=p>(</span><span class=n>end</span> <span class=o>-</span> <span class=n>start</span><span class=p>)</span><span class=o>.</span><span class=n>days</span> <span class=o>/</span> <span class=mi>360</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>rev</span> <span class=o>=</span> <span class=n>Operations</span><span class=p>(</span><span class=n>start_date</span><span class=o>=</span><span class=n>date</span><span class=p>(</span><span class=mi>2020</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>                 <span class=n>freq</span><span class=o>=</span><span class=n>relativedelta</span><span class=p>(</span><span class=n>months</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>                 <span class=n>initial_rev</span><span class=o>=</span><span class=mf>1000.0</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                 <span class=n>growth_rate</span><span class=o>=</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rev</span><span class=o>.</span><span class=n>amount</span><span class=p>(</span><span class=n>date</span><span class=p>(</span><span class=mi>2021</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># 1106.5402134963185</span>
</span></span></code></pre></div><p>Each time <code>amount</code> is called, it iterates through a new generator returned by <code>periods</code>. This is ineffecient since the same time periods are used each time. Printing 10 years of monthly revenue requires iterating through the <code>while</code> loop 7,260 times. More generally, it requires <code>n * (n + 1) / 2</code> iterations where <code>n</code> is the number of periods.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>timeit</span> <span class=kn>import</span> <span class=n>timeit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>revenue_series</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>rev</span><span class=o>.</span><span class=n>amount</span><span class=p>(</span><span class=n>dt</span><span class=p>)</span> <span class=k>for</span> <span class=n>dt</span> <span class=ow>in</span> <span class=p>(</span><span class=n>date</span><span class=p>(</span><span class=mi>2020</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>relativedelta</span><span class=p>(</span><span class=n>months</span><span class=o>=</span><span class=n>i</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>120</span><span class=p>))]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>count</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=n>time</span> <span class=o>=</span> <span class=n>timeit</span><span class=p>(</span><span class=n>revenue_series</span><span class=p>,</span> <span class=n>number</span><span class=o>=</span><span class=n>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>time</span> <span class=o>/</span> <span class=n>count</span> <span class=o>*</span> <span class=mi>1000</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1> ms per iteration&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 41.06 ms per iteration</span>
</span></span></code></pre></div><p>In a larger operating model with hundreds of line items instead of just <code>revenue</code>, this can add up to a significant amount of time. We can avoid this by caching the result each time a value is calculated in <code>periods</code>.</p><p>The following wrapper combines the instance method decorator with the generator caching decorator.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>itertools</span> <span class=kn>import</span> <span class=n>tee</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>types</span> <span class=kn>import</span> <span class=n>GeneratorType</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>wraps</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Tee</span> <span class=o>=</span> <span class=n>tee</span><span class=p>([],</span> <span class=mi>1</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=vm>__class__</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cached_generator</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cachename</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;_cached_</span><span class=si>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__qualname__</span><span class=si>}</span><span class=s2>_&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># try to get the cache from the object, or create if doesn&#39;t exist</span>
</span></span><span class=line><span class=cl>        <span class=n>cache</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>cachename</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cache</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cache</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=nb>setattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>cachename</span><span class=p>,</span> <span class=n>cache</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># return tee&#39;d generator</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>args</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cache</span><span class=p>[</span><span class=n>args</span><span class=p>]</span><span class=o>=</span><span class=n>func</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>cache</span><span class=p>[</span><span class=n>args</span><span class=p>],</span> <span class=p>(</span><span class=n>GeneratorType</span><span class=p>,</span> <span class=n>Tee</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>cache</span><span class=p>[</span><span class=n>args</span><span class=p>],</span> <span class=n>r</span> <span class=o>=</span> <span class=n>tee</span><span class=p>(</span><span class=n>cache</span><span class=p>[</span><span class=n>args</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>cache</span><span class=p>[</span><span class=n>args</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>wrapper</span>
</span></span></code></pre></div><p>We can use it in the <code>Operations</code> class to make <code>amount</code> significantly faster. In this example, more than 10x faster.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Operations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>start_date</span><span class=p>:</span> <span class=n>date</span>
</span></span><span class=line><span class=cl>    <span class=n>freq</span><span class=p>:</span> <span class=n>relativedelta</span>
</span></span><span class=line><span class=cl>    <span class=n>initial_rev</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>growth_rate</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@cached_generator</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>periods</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Revenue growth periods&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>curr</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>start_date</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>start_date</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>freq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>curr</span>
</span></span><span class=line><span class=cl>            <span class=n>curr</span> <span class=o>=</span> <span class=p>(</span><span class=n>curr</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>curr</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>freq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>amount</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>period_end</span><span class=p>:</span> <span class=n>date</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Revenue for period&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>revenue</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>initial_rev</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>start</span><span class=p>,</span> <span class=n>end</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>periods</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>period_end</span> <span class=o>&lt;=</span> <span class=n>start</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>revenue</span>
</span></span><span class=line><span class=cl>            <span class=n>revenue</span> <span class=o>*=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>growth_rate</span> <span class=o>*</span> <span class=p>(</span><span class=n>end</span> <span class=o>-</span> <span class=n>start</span><span class=p>)</span><span class=o>.</span><span class=n>days</span> <span class=o>/</span> <span class=mi>360</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>rev</span> <span class=o>=</span> <span class=n>Operations</span><span class=p>(</span><span class=n>start_date</span><span class=o>=</span><span class=n>date</span><span class=p>(</span><span class=mi>2020</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>                 <span class=n>freq</span><span class=o>=</span><span class=n>relativedelta</span><span class=p>(</span><span class=n>months</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>                 <span class=n>initial_rev</span><span class=o>=</span><span class=mf>1000.0</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                 <span class=n>growth_rate</span><span class=o>=</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>revenue_series</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>rev</span><span class=o>.</span><span class=n>amount</span><span class=p>(</span><span class=n>dt</span><span class=p>)</span> <span class=k>for</span> <span class=n>dt</span> <span class=ow>in</span> <span class=p>(</span><span class=n>date</span><span class=p>(</span><span class=mi>2020</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>relativedelta</span><span class=p>(</span><span class=n>months</span><span class=o>=</span><span class=n>i</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>120</span><span class=p>))]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>count</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=n>time</span> <span class=o>=</span> <span class=n>timeit</span><span class=p>(</span><span class=n>revenue_series</span><span class=p>,</span> <span class=n>number</span><span class=o>=</span><span class=n>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>time</span> <span class=o>/</span> <span class=n>count</span> <span class=o>*</span> <span class=mi>1000</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1> ms per iteration&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 3.05 ms per iteration</span>
</span></span></code></pre></div><p>This example highlights a scenario where caching generator methods might be helpful. There is an indefinite number of periods, and many generators are created returning the same values. The generator results are not large, so they can be stored in memory easily. <code>start_date</code> and <code>freq</code> can both be changed, so additional care is needed to ensure the cache remains valid (e.g. protecting with <code>@dataclass(frozen=True)</code> to make the attributes harder to change).</p><h2 id=final-thoughts class="relative group">Final thoughts <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#final-thoughts aria-label=Anchor>#</a></span></h2><ul><li>Don&rsquo;t use <code>functools.lru_cache</code> with instance methods. It can lead to memory leaks.</li><li>If you can&rsquo;t use <code>@staticmethod</code>, consider using <code>weakref</code> or storing the cache as an instance property.</li><li>Use <code>itertools.tee</code> to cache generator results (or consider calculating values ahead of time if possible).</li><li>Mutability is an issue with caching in Python. If you can&rsquo;t protect properties that the method relies on from changing, consider using a different approach.</li></ul></div></section><footer class="max-w-prose pt-8 print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/pydantic-with-third-party-types/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Pydantic With Third Party Types</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2023-12-13 21:52:40 -0500 -0500">13 December 2023</time>
</span></span></a></span><span><a class="group flex text-right" href=/posts/basic-financial-modeling-with-python/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Basic Financial Modeling With Python</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2024-01-07 15:28:54 -0500 -0500">7 January 2024</time>
</span></span><span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&rarr;</span><span class="ltr:hidden rtl:inline">&larr;</span></span></a></span></div></div></footer></article><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2024</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a></p></div><div class="flex flex-row items-center"></div></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm sm:p-6 md:p-[10vh] lg:p-[12vh] dark:bg-neutral-900/50" data-url=https://jrdnh.github.io/><div id=search-modal class="top-20 mx-auto flex min-h-0 w-full max-w-3xl flex-col rounded-md border border-neutral-200 bg-neutral shadow-lg dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex flex-none items-center justify-between px-2"><form class="flex min-w-0 flex-auto items-center"><div class="flex h-8 w-8 items-center justify-center text-neutral-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="mx-1 flex h-12 flex-auto appearance-none bg-transparent focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex h-8 w-8 items-center justify-center text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto overflow-auto px-2"><ul id=search-results></ul></section></div></div></div></body></html>