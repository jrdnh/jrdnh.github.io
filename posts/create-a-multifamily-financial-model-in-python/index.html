<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><title>Create a Multifamily Financial Model in Python &#183; jrdnh</title>
<meta name=title content="Create a Multifamily Financial Model in Python &#183; jrdnh"><script type=text/javascript src=/js/appearance.min.022d0ebc3b46a335eb1c7ef79b7f2de143d7cd5156d433638592ef1ce5f8554e.js integrity="sha256-Ai0OvDtGozXrHH73m38t4UPXzVFW1DNjhZLvHOX4VU4="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.846491e439ce18551a5c80d168997b32ad65350132e38fc9420189984a3e1a31.css integrity="sha256-hGSR5DnOGFUaXIDRaJl7Mq1lNQEy44/JQgGJmEo+GjE="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.5b9218820e6c6b9f04b4c5a03dffd0d57bc9189f511ee80ea74222de3a608e2f.js integrity="sha256-W5IYgg5sa58EtMWgPf/Q1XvJGJ9RHugOp0Ii3jpgji8=" data-copy=Copy data-copied=Copied></script><meta name=description content="
      
        This post creates a model that mirrors the spreadsheet here.
      
    "><link rel=canonical href=https://jrdnh.github.io/posts/create-a-multifamily-financial-model-in-python/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Create a Multifamily Financial Model in Python"><meta property="og:description" content="This post creates a model that mirrors the spreadsheet here."><meta property="og:type" content="article"><meta property="og:url" content="https://jrdnh.github.io/posts/create-a-multifamily-financial-model-in-python/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-15T11:15:39-05:00"><meta property="article:modified_time" content="2024-01-15T11:15:39-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Create a Multifamily Financial Model in Python"><meta name=twitter:description content="This post creates a model that mirrors the spreadsheet here."><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Create a Multifamily Financial Model in Python","headline":"Create a Multifamily Financial Model in Python","abstract":"This post creates a model that mirrors the spreadsheet here.","inLanguage":"en","url":"https:\/\/jrdnh.github.io\/posts\/create-a-multifamily-financial-model-in-python\/","author":{"@type":"Person","name":""},"copyrightYear":"2024","dateCreated":"2024-01-15T11:15:39-05:00","datePublished":"2024-01-15T11:15:39-05:00","dateModified":"2024-01-15T11:15:39-05:00","mainEntityOfPage":"true","wordCount":"2097"}</script><script defer data-domain=jrdnh.github.io data-api=https://plausible.io/api/event src=https://plausible.io/js/script.js></script></head><body class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral"><div id=the-top class="absolute flex self-center"><a class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 print:hidden sm:py-10 dark:text-neutral"><nav class="flex items-start justify-between sm:items-center"><div class="z-40 flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>jrdnh</a></div><label id=menu-button for=menu-controller class="block sm:hidden"><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="invisible fixed inset-0 z-30 m-auto h-full w-full cursor-default overflow-auto bg-neutral-100/50 opacity-0 backdrop-blur-sm transition-opacity dark:bg-neutral-900/50"><ul class="mx-auto flex w-full max-w-7xl list-none flex-col overflow-visible px-6 py-6 text-end sm:px-14 sm:py-10 sm:pt-10 md:px-24 lg:px-32"><li class=mb-1><span class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class="group mb-1"><a href=/posts/ title onclick=close_menu()><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Posts</span></a></li><li class="group mb-1"><a href=https://github.com/jrdnh title onclick=close_menu() target=_blank><span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></li><li class="group mb-1"><button id=search-button-1 title="Search (/)">
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li><li class="group mb-1"><button id=appearance-switcher-1 type=button aria-label="appearance switcher">
<span class="group-dark:hover:text-primary-400 inline transition-colors group-hover:text-primary-600 dark:hidden" title="Switch to dark appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span>
</span><span class="group-dark:hover:text-primary-400 hidden transition-colors group-hover:text-primary-600 dark:inline" title="Switch to light appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></span></button></li></ul></div></label><ul class="hidden list-none flex-row text-end sm:flex"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=/posts/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Posts</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=https://github.com/jrdnh title target=_blank><span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><button id=search-button-2 title="Search (/)">
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><button id=appearance-switcher-2 type=button aria-label="appearance switcher">
<span class="group-dark:hover:text-primary-400 inline transition-colors group-hover:text-primary-600 dark:hidden" title="Switch to dark appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span>
</span><span class="group-dark:hover:text-primary-400 hidden transition-colors group-hover:text-primary-600 dark:inline" title="Switch to light appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></span></button></li></ul></nav></header><div class="relative flex grow flex-col"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Create a Multifamily Financial Model in Python</h1><div class="mb-12 mt-8 text-base text-neutral-500 print:hidden dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime="2024-01-15 11:15:39 -0500 -0500">15 January 2024</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">10 mins</span></div></div></header><section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8"><div class="toc pe-5 print:hidden lg:sticky lg:top-10"><details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5"><summary class="-ms-5 block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 lg:hidden dark:bg-neutral-700 dark:text-neutral-100">Table of Contents</summary><div class="-ms-5 border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#companion-file-setup>Companion file setup</a></li><li><a href=#model-construction>Model construction</a><ul><li><a href=#model-overview>Model overview</a></li></ul></li><li><a href=#line-item-classes>Line item classes</a><ul><li><a href=#year-fractions>Year fractions</a></li></ul></li><li><a href=#model-usage>Model usage</a></li><li><a href=#challenges-with-this-approach>Challenges with this approach</a><ul><li><a href=#performance-and-profiling-details>Performance and profiling details</a></li></ul></li></ul></nav></div></details></div></div><div class="min-h-0 min-w-0 max-w-prose grow"><p><em>This post creates a model that mirrors the spreadsheet
<a href="https://docs.google.com/spreadsheets/d/1iRkhis-IToZ07XGRHkGxtLfSU2PhwP7tGWMgULRAjSw/edit?usp=sharing" target=_blank rel=noreferrer>here</a>.</em></p><p>The objective of this post is to create a financial model for an apartment building. Each line item of the operating model should accept arbitrary <code>from_date</code> and <code>to_date</code> parameters. For example, net operating income (NOI):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>noi</span><span class=p>(</span><span class=n>from_date</span><span class=o>=</span><span class=n>date</span><span class=p>(</span><span class=n>yyyy</span><span class=p>,</span> <span class=n>mm</span><span class=p>,</span> <span class=n>dd</span><span class=p>),</span> <span class=n>to_date</span><span class=o>=</span><span class=n>date</span><span class=p>(</span><span class=n>yyyy</span><span class=p>,</span> <span class=n>mm</span><span class=p>,</span> <span class=n>dd</span><span class=p>))</span>
</span></span></code></pre></div><p>Sub-items, effective gross income (EGI) and operating expenses (opex) in the case of NOI, should be accessible as attributes all the way down the basic operating assumptions.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>noi</span><span class=o>.</span><span class=n>egi</span><span class=p>(</span><span class=n>from_date</span><span class=o>=</span><span class=n>date</span><span class=p>(</span><span class=n>yyyy</span><span class=p>,</span> <span class=n>mm</span><span class=p>,</span> <span class=n>dd</span><span class=p>),</span> <span class=n>to_date</span><span class=o>=</span><span class=n>date</span><span class=p>(</span><span class=n>yyyy</span><span class=p>,</span> <span class=n>mm</span><span class=p>,</span> <span class=n>dd</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>noi</span><span class=o>.</span><span class=n>opex</span><span class=p>(</span><span class=n>from_date</span><span class=o>=</span><span class=n>date</span><span class=p>(</span><span class=n>yyyy</span><span class=p>,</span> <span class=n>mm</span><span class=p>,</span> <span class=n>dd</span><span class=p>),</span> <span class=n>to_date</span><span class=o>=</span><span class=n>date</span><span class=p>(</span><span class=n>yyyy</span><span class=p>,</span> <span class=n>mm</span><span class=p>,</span> <span class=n>dd</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># net operating income &gt; effective gross income &gt; potential gross rent &gt; average monthly rent per square foot</span>
</span></span><span class=line><span class=cl><span class=n>noi</span><span class=o>.</span><span class=n>egi</span><span class=o>.</span><span class=n>gross_potential_rent</span><span class=o>.</span><span class=n>avg_monthly_rent_psf</span><span class=p>(</span><span class=n>from_date</span><span class=o>=</span><span class=n>date</span><span class=p>(</span><span class=n>yyyy</span><span class=p>,</span> <span class=n>mm</span><span class=p>,</span> <span class=n>dd</span><span class=p>),</span> <span class=n>to_date</span><span class=o>=</span><span class=n>date</span><span class=p>(</span><span class=n>yyyy</span><span class=p>,</span> <span class=n>mm</span><span class=p>,</span> <span class=n>dd</span><span class=p>))</span>
</span></span></code></pre></div><p>Finally, the model needs to be able to match the equivalent Excel model. In particular, it should be able to capture discrete period changes (to mirror an Excel model where columns represent months) even though line item functions should accept arbitrary date ranges.</p><p>This post discusses some of the successes and challenges in meeting these modeling objectives. It isn&rsquo;t a definitive guide. It also does not step through every line of the companion files.</p><ul><li><a href=#companion-file-setup>Companion file setup</a></li><li><a href=#model-construction>Model construction</a><ul><li><a href=#model-overview>Model overview</a></li><li><a href=#line-item-classes>Line item classes</a></li><li><a href=#year-fractions>Year fractions</a></li></ul></li><li><a href=#model-usage>Model usage</a></li><li><a href=#challenges-with-this-approach>Challenges with this approach</a><ul><li><a href=#performance-and-profiling-details>Performance and profiling details</a></li></ul></li></ul><h2 id=companion-file-setup class="relative group">Companion file setup <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#companion-file-setup aria-label=Anchor>#</a></span></h2><p>The three companion files for this post are in
<a href=https://gist.github.com/jrdnh/fb26772b430283344d887916b4609979 target=_blank rel=noreferrer>this Gist</a>. The files are:</p><ul><li><code>models.py</code> - Pydantic-compatible wrappers <code>relativedelta</code> similar to the ones in
<a href=https://jrdnh.github.io/posts/pydantic-with-third-party-types/ target=_blank rel=noreferrer>this previous post</a>, and a <code>FixedIntervalSeries</code> class that yields a series of dates at a fixed interval similar to the class in
<a href=https://jrdnh.github.io/posts/basic-financial-modeling-with-python/#refactor-to-make-it-a-bit-more-generic target=_blank rel=noreferrer>this previous post</a>.</li><li><code>utils.py</code> - Utility functions for working with dates, iterables, and printing.</li><li><code>companion.py</code> - The companion script that creates and runs the model.</li></ul><p>The companion files were created with Python 3.12 and use <code>pydantic==2.5.2</code> and <code>python-dateutil==2.8.2</code>. Other versions may work but have not been tested.</p><h2 id=model-construction class="relative group">Model construction <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#model-construction aria-label=Anchor>#</a></span></h2><h3 id=model-overview class="relative group">Model overview <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#model-overview aria-label=Anchor>#</a></span></h3><p>The model is structured as tree of financial line items. The nodes are classes. Class attributes are annotated with their types.</p><pre tabindex=0><code>NetOperatingIncome
├── EffectiveGrossIncome
│   ├── AvgVacancyRate
│   │   └── vacancy_rates: list[float]
│   └── GrossPotentialRent
│       ├── vacancy: method
│       ├── sf: int
│       └── AvgMonthlyRentPSF
│           ├── initial_rent_psf: float
│           └── rent_growth_rate: float
└── TotalExpenses
    ├── OperatingExpenses
    │   ├── units: int
    │   ├── initial_opex_pu: float
    │   └── opex_growth_rate: float 
    ├── RealEstateTaxes
    │   ├── sf: int
    │   ├── monthly_re_tax_psf: float
    │   └── ret_growth_rate: float 
    └── ReplacementReserves
        ├── units: int
        ├── annual_reserves_pu: float
        └── rr_growth_rate: float 
</code></pre><p>Each class is a callable that takes <code>from_dt: date</code> and <code>to_dt: date</code> arguments and returns the total (or in some cases average) line item value. Values are from but excluding the first date, and to and including the second date. This argument convention aligns with using consecutive <code>(start date, end date]</code> periods.</p><h2 id=line-item-classes class="relative group">Line item classes <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#line-item-classes aria-label=Anchor>#</a></span></h2><p>Building line items as class instances with subitems as attributes gives the model structure. Subitems are accessible through regular dot notation. Each line item is a separate class, although <code>OperatingExpenses</code>, <code>RealEstateTaxes</code>, and <code>ReplacementReserves</code> are essentially the same classes with different property names. Each of these three classes model expenses that start at some value and grow stepwise at some specified, fixed interval (monthly, semi-annually). This type of periodic growth is a common pattern, so it might make sense to abstract these lines into a separate class.</p><p>Each line item class is a subclass of <code>FixedIntervalSeries</code> from the <code>models.py</code> file. The <code>FixedIntervalSeries</code> class takes <code>ref_date: date</code> and <code>freq: RelativeDelta</code> constructor parameters. It has a single method <code>periods</code> that returns a generator yielding a series of dates with a constant offset defined by the <code>freq</code> property.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>FixedIntervalSeries</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ref_date</span><span class=p>:</span> <span class=n>date</span>
</span></span><span class=line><span class=cl>    <span class=n>freq</span><span class=p>:</span> <span class=n>RelativeDelta</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>periods</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>curr_date</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ref_date</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=p>(</span><span class=n>curr_date</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>freq</span> <span class=o>*</span> <span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>index</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span></code></pre></div><p>It can be used as follows to create a series of evenly spaced dates.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>date</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>models</span> <span class=kn>import</span> <span class=n>FixedIntervalSeries</span><span class=p>,</span> <span class=n>RelativeDelta</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>series</span> <span class=o>=</span> <span class=n>FixedIntervalSeries</span><span class=p>(</span><span class=n>ref_date</span><span class=o>=</span><span class=n>date</span><span class=p>(</span><span class=mi>2020</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=n>freq</span><span class=o>=</span><span class=n>relativedelta</span><span class=p>(</span><span class=n>months</span><span class=o>=</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>series_generator</span> <span class=o>=</span> <span class=n>series</span><span class=o>.</span><span class=n>periods</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>([</span><span class=nb>next</span><span class=p>(</span><span class=n>series_generator</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>)])</span>
</span></span><span class=line><span class=cl><span class=c1># [datetime.date(2020, 1, 1), datetime.date(2020, 2, 1), datetime.date(2020, 3, 1)]</span>
</span></span></code></pre></div><p>Or using <code>itertools.pairwise</code>, create series of <code>(start_date, end_date)</code> tuples defining both edges of a period.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>itertools</span> <span class=kn>import</span> <span class=n>islice</span><span class=p>,</span> <span class=n>pairwise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>list</span><span class=p>(</span><span class=n>islice</span><span class=p>(</span><span class=n>pairwise</span><span class=p>(</span><span class=n>series</span><span class=o>.</span><span class=n>periods</span><span class=p>()),</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># [(datetime.date(2020, 1, 1), datetime.date(2020, 2, 1)), (datetime.date(2020, 2, 1), datetime.date(2020, 3, 1))]</span>
</span></span></code></pre></div><p>The <code>periods</code> function provides the time events required to calculate discrete time intervals. Note that most of the <code>periods</code> functions in this model yield evenly spaced dates, but yielding the next eventful date (regardless of time interval) is the only requirement.</p><p>Looping over <code>periods</code>, in combination with <code>itertools.takewhile</code> and year fraction functions, gives us a way to calculate values dependent on discrete intervals over arbitrary time periods. The annotated <code>RealEstateTaxes</code> class shows how you can calculate tax expense that increases a fixed percentage at fixed intervals. Initializing with <code>freq=RelativeDelta(years=1)</code> and <code>ret_growth_rate=0.05</code> would step up the expense by 5.0% on the anniversary of each <code>ref_date</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>RealEstateTaxes</span><span class=p>(</span><span class=n>FixedIntervalSeries</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sf</span><span class=p>:</span> <span class=nb>int</span>  <span class=c1># square feet</span>
</span></span><span class=line><span class=cl>    <span class=n>monthly_re_tax_psf</span><span class=p>:</span> <span class=nb>float</span>  <span class=c1># monthly real estate taxes per square foot</span>
</span></span><span class=line><span class=cl>    <span class=n>ret_growth_rate</span><span class=p>:</span> <span class=nb>float</span>  <span class=c1># annual real estate tax growth rate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>from_dt</span><span class=p>:</span> <span class=n>date</span><span class=p>,</span> <span class=n>to_dt</span><span class=p>:</span> <span class=n>date</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Real estate taxes from but excluding `from_dt` to and including `to_dt`.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># Generator over (period index, (period start date, period end date)), </span>
</span></span><span class=line><span class=cl>        <span class=c1># stopping when periods are past the requested date range</span>
</span></span><span class=line><span class=cl>        <span class=n>periods</span> <span class=o>=</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>takewhile</span><span class=p>(</span><span class=k>lambda</span> <span class=n>p</span><span class=p>:</span> <span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>to_dt</span><span class=p>,</span> <span class=n>pairwise</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>periods</span><span class=p>())))</span>
</span></span><span class=line><span class=cl>        <span class=c1># Initialize values</span>
</span></span><span class=line><span class=cl>        <span class=n>accumulated_amt</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>period_amt</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>monthly_re_tax_psf</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>sf</span> <span class=o>*</span> <span class=mi>12</span>  <span class=c1># first period amount, annualized</span>
</span></span><span class=line><span class=cl>        <span class=c1># Loop over each period and calculate the applicable tax expense</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=n>per_start</span><span class=p>,</span> <span class=n>per_end</span><span class=p>)</span> <span class=ow>in</span> <span class=n>periods</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Since we want the expense for the first period to equal the initial `monthly_re_tax_psf`,</span>
</span></span><span class=line><span class=cl>            <span class=c1># only increase the expense if i &gt; 0</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>period_amt</span> <span class=o>=</span> <span class=n>period_amt</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>ret_growth_rate</span> <span class=o>*</span> <span class=n>YF</span><span class=o>.</span><span class=n>monthly</span><span class=p>(</span><span class=n>per_start</span><span class=p>,</span> <span class=n>per_end</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=c1># Add the expense for the portion of each period that overlaps with (from_dt, to_date)</span>
</span></span><span class=line><span class=cl>            <span class=n>accumulated_amt</span> <span class=o>+=</span> <span class=n>period_amt</span> <span class=o>*</span> <span class=nb>max</span><span class=p>(</span><span class=n>YF</span><span class=o>.</span><span class=n>monthly</span><span class=p>(</span><span class=nb>max</span><span class=p>(</span><span class=n>per_start</span><span class=p>,</span> <span class=n>from_dt</span><span class=p>),</span> <span class=nb>min</span><span class=p>(</span><span class=n>per_end</span><span class=p>,</span> <span class=n>to_dt</span><span class=p>)),</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>accumulated_amt</span>
</span></span></code></pre></div><p>This approach uses the actual dates in each period to determine tax expense for each period. It would be less code to just increase the tax expense each period by multiplying the previous period&rsquo;s expense by the growth rate:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>from_dt</span><span class=p>:</span> <span class=n>date</span><span class=p>,</span> <span class=n>to_dt</span><span class=p>:</span> <span class=n>date</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=n>start</span><span class=p>,</span> <span class=n>end</span><span class=p>)</span> <span class=ow>in</span> <span class=n>periods</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>period_amt</span> <span class=o>*=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>ret_growth_rate</span> <span class=o>*</span> <span class=n>YF</span><span class=o>.</span><span class=n>thrity360</span><span class=p>(</span><span class=n>start</span><span class=p>,</span> <span class=n>end</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span></code></pre></div><p>The issue with this approach is that it ties the starting value <code>monthly_re_tax_psf</code> to the interval duration <code>freq</code>. If periods do not have the same duration or you want to change the period frequency, the starting value no longer works.</p><h3 id=year-fractions class="relative group">Year fractions <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#year-fractions aria-label=Anchor>#</a></span></h3><p>The <code>YF</code> class in <code>utils.py</code> holds three year fraction formulas: <code>actual360</code> for an actual/360 day count convention (<code>=YEAR(,,2)</code> in Excel), <code>thirty360</code> for a 30/360 convention (<code>=YEAR(,,0)</code> in Excel), and <code>monthly</code> (which does not have an Excel equivalent).</p><p>The <code>monthly</code> function returns one 1/12th for each whole calendar month and the pro rata portion of any stub months based on the actual number of days elapsed and the actual number of days in the month. It is similar to a 30/360 convention with a few changes.</p><style type=text/css>.tg{border-collapse:collapse;border-spacing:0}.tg td{border-color:#000;border-style:solid;border-width:1px;font-family:Arial,sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal}.tg th{border-color:#000;border-style:solid;border-width:1px;font-family:Arial,sans-serif;font-size:14px;font-weight:400;overflow:hidden;padding:10px 5px;word-break:normal}.tg .tg-0pky{border-color:inherit;text-align:left;vertical-align:top}</style><table class=tg><thead><tr><th class=tg-0pky></th><th class=tg-0pky>30/360</th><th class=tg-0pky><span style=color:#905;background-color:#ddd>`YF.monthly`</span></th></tr></thead><tbody><tr><td class=tg-0pky>Whole non-calendar months<br><span style=font-weight:400;font-style:normal;text-decoration:none>(e.g. 2020-06-15 to 2020-07-15)</span><br></td><td class=tg-0pky>Equals 1/12th of a year<br><br><span style=color:#905;background-color:#ddd>=YEARFRAC("2020-06-15", "2020-07-15", 0)</span><br>0.08333333333333333</td><td class=tg-0pky>Depends whether the stub starting month and ending month<br>have the same number of days<br><span style=color:#905;background-color:#ddd>>>> YF.monthly(date(2020,6,15), date(2020,7,15))</span><br>0.08198924731182795</td></tr><tr><td class=tg-0pky>Month end to month end periods</td><td class=tg-0pky>Depends on whether the month is February or March<br><span style=color:#905;background-color:#ddd>=YEARFRAC("2020-01-31", "2020-02-29", 0)</span><br>0.0805555555555556<br><span style=color:#905;background-color:#ddd>=YEARFRAC("2020-02-29", "2020-03-31", 0)</span><br>0.0861111111111111</td><td class=tg-0pky>Always equals 1/12th of a year<br><br><span style=color:#905;background-color:#ddd>>>> YF.monthly(date(2020,1,31), date(2020,2,29))</span><br>0.08333333333333333<br></td></tr><tr><td class=tg-0pky>Last day of a month with 31 days</td><td class=tg-0pky>Equals zero<br><span style=color:#905;background-color:#ddd>=YEARFRAC("2020-07-31", "2020-07-31", 0)</span><br>0.0</td><td class=tg-0pky>Equals 1/31st of a month [i.e. (1 / 31) / 12]<br><span style=color:#905;background-color:#ddd>>>> YF.monthly(date(2020,7,30), date(2020,7,31))</span><br>0.0026881720430107525</td></tr></tbody></table><p><code>YF.monthly</code> allows you to create discrete, even calendar month accruals and growth rates from two <code>date</code>s. While not necessarily required to develop a good model, it is helpful when trying to tie back to an Excel model where users model monthly columns of data.</p><h2 id=model-usage class="relative group">Model usage <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#model-usage aria-label=Anchor>#</a></span></h2><p>This model is fully Pydantic-compatible. You can build the model from the JSON assumptions hosted in
<a href=https://gist.githubusercontent.com/jrdnh/377f13e0ed0e6ac975b5d36156dd27f5/raw/44bb448d60ff6aae9cc5f5d9472edf9e0c0b85d3/noi.json target=_blank rel=noreferrer>this Gist</a>. Assuming you are in the same directory has the companion file <code>companion.py</code> and have the <code>pydantic</code> and <code>python-dateutil</code> dependencies installed, you can create an instance of the model with the commands below.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib.request</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>companion</span> <span class=kn>import</span> <span class=n>NetOperatingIncome</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=s1>&#39;https://gist.githubusercontent.com/jrdnh/377f13e0ed0e6ac975b5d36156dd27f5/raw/44bb448d60ff6aae9cc5f5d9472edf9e0c0b85d3/noi.json&#39;</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>urllib</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>urlopen</span><span class=p>(</span><span class=n>url</span><span class=p>)</span> <span class=k>as</span> <span class=n>response</span><span class=p>:</span>
</span></span><span class=line><span class=cl>   <span class=n>noi</span> <span class=o>=</span> <span class=n>NetOperatingIncome</span><span class=o>.</span><span class=n>model_validate_json</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
</span></span></code></pre></div><p>Now you have a full model of financial projetions for this apartment building!</p><p>Try getting net operating income over the first year.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>date</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>noi</span><span class=p>(</span><span class=n>date</span><span class=p>(</span><span class=mi>2019</span><span class=p>,</span> <span class=mi>12</span><span class=p>,</span> <span class=mi>31</span><span class=p>),</span> <span class=n>date</span><span class=p>(</span><span class=mi>2020</span><span class=p>,</span> <span class=mi>12</span><span class=p>,</span> <span class=mi>31</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># 4667040.0</span>
</span></span></code></pre></div><p>Get the average monthly rent per square foot between two random dates (for example, 2 June 2021 to 27 September 2023).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>noi</span><span class=o>.</span><span class=n>effective_gross_income</span><span class=o>.</span><span class=n>gross_potential_rent</span><span class=o>.</span><span class=n>avg_monthly_rent_psf</span><span class=p>(</span><span class=n>date</span><span class=p>(</span><span class=mi>2021</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span> <span class=n>date</span><span class=p>(</span><span class=mi>2023</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>27</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># 3.292631202107785</span>
</span></span></code></pre></div><p>Line items are <code>FixedIntervalSeries</code> instances. If we want to display the full pro forma for all line items on a monthly basis, we can recursively iterate over each attribute and try calling it with a series of monthly periods. The helper <code>field_values</code> creates a nested dictionary of line items with their values, and <code>flatten</code> flattens the dictionary.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>itertools</span> <span class=kn>import</span> <span class=n>pairwise</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>utils</span> <span class=kn>import</span> <span class=n>field_values</span><span class=p>,</span> <span class=n>flatten</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>models</span> <span class=kn>import</span> <span class=n>RelativeDelta</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ten_years_monthly</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>pairwise</span><span class=p>((</span><span class=n>date</span><span class=p>(</span><span class=mi>2019</span><span class=p>,</span> <span class=mi>12</span><span class=p>,</span> <span class=mi>31</span><span class=p>)</span> <span class=o>+</span> <span class=n>RelativeDelta</span><span class=p>(</span><span class=n>months</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>121</span><span class=p>))))</span>
</span></span><span class=line><span class=cl><span class=n>pro_forma</span> <span class=o>=</span> <span class=n>flatten</span><span class=p>(</span><span class=n>field_values</span><span class=p>(</span><span class=n>noi</span><span class=p>,</span> <span class=n>ten_years_monthly</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>pro_forma</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># long json output</span>
</span></span></code></pre></div><p>Pandas displays tables nicely. It is also easy to copy DataFrames to the clipboard or write directly to a <code>.xlsx</code> file. Make sure you have <code>pandas</code> installed before running the following code.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>pro_forma</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=p>[</span><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>ten_years_monthly</span><span class=p>])</span><span class=o>.</span><span class=n>T</span>
</span></span><span class=line><span class=cl><span class=c1># df.to_clipboard()</span>
</span></span><span class=line><span class=cl><span class=c1># df.to_excel(&#39;pro_forma.xlsx&#39;)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#                                                     2020-01-31  2020-02-29  2020-03-31  ...     2029-10-31     2029-11-30     2029-12-31</span>
</span></span><span class=line><span class=cl><span class=c1># .effective_gross_income.avg_vacancy_rate                  0.10        0.10        0.10  ...       0.050000       0.050000       0.050000</span>
</span></span><span class=line><span class=cl><span class=c1># .effective_gross_income.gross_potential_rent.av...        3.16        3.16        3.16  ...       3.776493       3.776493       3.776493</span>
</span></span><span class=line><span class=cl><span class=c1># .effective_gross_income.gross_potential_rent         568800.00   568800.00   568800.00  ...  679768.653032  679768.653032  679768.653032</span>
</span></span><span class=line><span class=cl><span class=c1># .effective_gross_income                              511920.00   511920.00   511920.00  ...  645780.220381  645780.220381  645780.220381</span>
</span></span><span class=line><span class=cl><span class=c1># .total_expenses.operating_expenses                   -63250.00   -63250.00   -63250.00  ...  -75589.604965  -75589.604965  -75589.604965</span>
</span></span><span class=line><span class=cl><span class=c1># .total_expenses.real_estate_taxes                    -54000.00   -54000.00   -54000.00  ...  -64534.998706  -64534.998706  -64534.998706</span>
</span></span><span class=line><span class=cl><span class=c1># .total_expenses.replacement_reserves                  -5750.00    -5750.00    -5750.00  ...   -6871.782270   -6871.782270   -6871.782270</span>
</span></span><span class=line><span class=cl><span class=c1># .total_expenses                                     -123000.00  -123000.00  -123000.00  ... -146996.385941 -146996.385941 -146996.385941</span>
</span></span><span class=line><span class=cl><span class=c1># .                                                    388920.00   388920.00   388920.00  ...  498783.834440  498783.834440  498783.834440</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [9 rows x 120 columns]</span>
</span></span></code></pre></div><h2 id=challenges-with-this-approach class="relative group">Challenges with this approach <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#challenges-with-this-approach aria-label=Anchor>#</a></span></h2><ul><li><strong>Sibling dependencies:</strong> You might have noticed that vacancy is modeled using a method of <code>EffectiveGrossIncome</code> instead of as a custom class. That&rsquo;s because it relies on gross potential rent which is a sibling in the hierarchy (vacany expense = gross potential rent * vacancy rate). For more complicated leasing arrangements such as net leases, reimbursement lines in the revenue section rely on lines buried all they way down in the expense section of the statement. Using dependencies down the tree work well, but dependencies up and across the tree are difficult to navigate.</li><li><strong>Assumption references:</strong> If you
<a href=https://gist.githubusercontent.com/jrdnh/377f13e0ed0e6ac975b5d36156dd27f5/raw/44bb448d60ff6aae9cc5f5d9472edf9e0c0b85d3/noi.json target=_blank rel=noreferrer>look</a> at the serialized assumptions for this model you&rsquo;ll see a lot of the same values. In this case, all the <code>ref_date</code>s are the same analysis start date of December 12, 2019. If you wanted to change the analysis start date, you&rsquo;d have to update the assumption in many places.</li><li><strong>Performance:</strong> The <code>periods</code> date generators are inefficient. Calculating a full 10-year schedule of monthly values for all line items takes more than a third of second. <code>periods</code> is called almost 25,000 times. Practical models generally have mid to high hundreds of line items which implies this model is too slow to be useful. <code>periods</code> is a good candidate for caching though, both within subclasses and potentially across subclasses, since the same arguments are called repeatedly and generator outputs are small.</li></ul><h3 id=performance-and-profiling-details class="relative group">Performance and profiling details <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#performance-and-profiling-details aria-label=Anchor>#</a></span></h3><p>Time duration to create a full 10-year schedule of monthly values.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>perf_counter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>duration</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>start</span> <span class=o>=</span> <span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>field_values</span><span class=p>(</span><span class=n>noi</span><span class=p>,</span> <span class=n>ten_years_monthly</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>((</span><span class=n>perf_counter</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span><span class=p>)</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>,</span> <span class=s1>&#39;ms&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>duration</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># 370.89961499441415 ms</span>
</span></span></code></pre></div><p>Key profiling results.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>cProfile</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pstats</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>profiler</span> <span class=o>=</span> <span class=n>cProfile</span><span class=o>.</span><span class=n>Profile</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>profiler</span><span class=o>.</span><span class=n>enable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>field_values</span><span class=p>(</span><span class=n>noi</span><span class=p>,</span> <span class=n>ten_years_monthly</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>profiler</span><span class=o>.</span><span class=n>disable</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>stats</span> <span class=o>=</span> <span class=n>pstats</span><span class=o>.</span><span class=n>Stats</span><span class=p>(</span><span class=n>profiler</span><span class=p>)</span><span class=o>.</span><span class=n>sort_stats</span><span class=p>(</span><span class=s1>&#39;tottime&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>stats</span><span class=o>.</span><span class=n>print_stats</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#          1129336 function calls (1129297 primitive calls) in 0.870 seconds</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#    Ordered by: internal time</span>
</span></span><span class=line><span class=cl><span class=c1>#    List reduced from 53 to 10 due to restriction &lt;10&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#    ncalls  tottime  percall  cumtime  percall filename:lineno(function)</span>
</span></span><span class=line><span class=cl><span class=c1>#     21358    0.130    0.000    0.265    0.000 /.../dateutil/relativedelta.py:317(__add__)</span>
</span></span><span class=line><span class=cl><span class=c1>#     21358    0.084    0.000    0.305    0.000 /.../dateutil/relativedelta.py:495(__mul__)</span>
</span></span><span class=line><span class=cl><span class=c1>#     62662    0.083    0.000    0.152    0.000 /.../python3.12/calendar.py:154(weekday)</span>
</span></span><span class=line><span class=cl><span class=c1>#     21358    0.063    0.000    0.222    0.000 /.../dateutil/relativedelta.py:105(__init__)</span>
</span></span><span class=line><span class=cl><span class=c1>#     42716    0.056    0.000    0.102    0.000 {built-in method builtins.any}</span>
</span></span><span class=line><span class=cl><span class=c1>#     20652    0.043    0.000    0.161    0.000 /.../utils.py:50(monthly)</span>
</span></span><span class=line><span class=cl><span class=c1>#     62662    0.034    0.000    0.187    0.000 /.../calendar.py:161(monthrange)</span>
</span></span><span class=line><span class=cl><span class=c1>#     62662    0.033    0.000    0.054    0.000 /.../python3.12/enum.py:709(__call__)</span>
</span></span><span class=line><span class=cl><span class=c1>#     21358    0.030    0.000    0.049    0.000 /.../dateutil/relativedelta.py:231(_fix)</span>
</span></span><span class=line><span class=cl><span class=c1>#     24598    0.030    0.000    0.613    0.000 /.../models.py:105(periods)</span>
</span></span></code></pre></div><p>Most of the time is spent creating, multiplying, and adding <code>dateutil.relativedelta.relativedelta</code> objects inside the body of <code>FixedIntervalSeries.periods</code>. <code>FixedIntervalSeries.periods</code> is called almost 25,000 times (see last line or results table).</p></div></section><footer class="max-w-prose pt-8 print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/basic-financial-modeling-with-python/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Basic Financial Modeling With Python</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2024-01-07 15:28:54 -0500 -0500">7 January 2024</time>
</span></span></a></span><span><a class="group flex text-right" href=/posts/improve-model-navigation/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Improve Model Navigation</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2024-01-23 21:27:24 -0500 -0500">23 January 2024</time>
</span></span><span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&rarr;</span><span class="ltr:hidden rtl:inline">&larr;</span></span></a></span></div></div></footer></article><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2024</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a></p></div><div class="flex flex-row items-center"></div></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm sm:p-6 md:p-[10vh] lg:p-[12vh] dark:bg-neutral-900/50" data-url=https://jrdnh.github.io/><div id=search-modal class="top-20 mx-auto flex min-h-0 w-full max-w-3xl flex-col rounded-md border border-neutral-200 bg-neutral shadow-lg dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex flex-none items-center justify-between px-2"><form class="flex min-w-0 flex-auto items-center"><div class="flex h-8 w-8 items-center justify-center text-neutral-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="mx-1 flex h-12 flex-auto appearance-none bg-transparent focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex h-8 w-8 items-center justify-center text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto overflow-auto px-2"><ul id=search-results></ul></section></div></div></div></body></html>